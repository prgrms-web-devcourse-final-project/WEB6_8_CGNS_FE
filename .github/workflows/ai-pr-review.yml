name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      run: |
        # Get the list of changed files
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(kt|kts|java|sql|yml|yaml|properties|md)$' | head -20)
        echo "files<<CHANGEDFILES" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "CHANGEDFILES" >> $GITHUB_OUTPUT

    - name: Read changed files content
      id: file-content
      run: |
        CONTENT=""
        if [ -n "${{ steps.changed-files.outputs.files }}" ]; then
          while IFS= read -r file; do
            if [ -f "$file" ] && [ -s "$file" ]; then
              echo "Processing: $file"
              CONTENT="${CONTENT}

--- File: $file ---
"
              FILE_CONTENT=$(head -c 8000 "$file")
              CONTENT="${CONTENT}${FILE_CONTENT}"
            fi
          done <<< "${{ steps.changed-files.outputs.files }}"
        fi

        echo "content<<FILECONTENT" >> $GITHUB_OUTPUT
        echo "$CONTENT" >> $GITHUB_OUTPUT
        echo "FILECONTENT" >> $GITHUB_OUTPUT

    - name: AI Code Review
      id: ai-review
      run: |
        if [ -z "${{ steps.file-content.outputs.content }}" ]; then
          echo "No relevant files changed"
          echo "review=No Kotlin/configuration files were changed in this PR." >> $GITHUB_OUTPUT
          exit 0
        fi

        REVIEW=$(curl -s -X POST "https://openrouter.ai/api/v1/chat/completions" \
          -H "Authorization: Bearer ${{ secrets.OPENROUTER_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "model": "x-ai/grok-4-fast:free",
            "messages": [
              {
                "role": "system",
                "content": "ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. ë‹¤ìŒ ê·œì¹™ë§Œ ê²€í† í•˜ì„¸ìš”:\n\n## ê²€í†  í•­ëª©\n1. **ê¸€ë¡œë²Œ ìµì…‰ì…˜ ì²˜ë¦¬**: @ControllerAdvice ì‚¬ìš©, í‘œì¤€ ì—ëŸ¬ ì‘ë‹µ\n2. **ApiResponse ì‚¬ìš©**: ëª¨ë“  APIëŠ” ApiResponse<T>ë¡œ ê°ì‹¸ì„œ ì‘ë‹µ\n3. **Kotlin ìµœì í™”**: data class, null safety, when í‘œí˜„ì‹, í™•ì¥í•¨ìˆ˜ ë“±\n4. **ktlint ê·œì¹™**: í¬ë§·íŒ…, ë„¤ì´ë° ì»¨ë²¤ì…˜\n\n## ì‘ë‹µ í˜•ì‹\n### âœ… ì¤€ìˆ˜ì‚¬í•­\n- [ì˜ ì§€ì¼œì§„ ë¶€ë¶„]\n\n### âŒ ìœ„ë°˜ì‚¬í•­  \n- [íŒŒì¼:ë¼ì¸] ë¬¸ì œì ê³¼ ìˆ˜ì •ë°©ë²•\n\n**ì ìˆ˜**: X/10"
              },
              {
                "role": "user",
                "content": "ë‹¤ìŒ PRì˜ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”:\n\nPR ì œëª©: ${{ github.event.pull_request.title }}\nPR ì„¤ëª…: ${{ github.event.pull_request.body }}\n\në³€ê²½ëœ íŒŒì¼ë“¤:\n${{ steps.file-content.outputs.content }}"
              }
            ],
            "temperature": 0.3
          }')

        # Extract the review content
        REVIEW_CONTENT=$(echo "$REVIEW" | jq -r '.choices[0].message.content // "ë¦¬ë·° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."')

        echo "review<<EOF" >> $GITHUB_OUTPUT
        echo "$REVIEW_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Post review comment
      uses: actions/github-script@v7
      with:
        script: |
          const review = `${{ steps.ai-review.outputs.review }}`;

          // Find existing review comment
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.data.find(comment =>
            comment.user.login === 'github-actions[bot]' &&
            comment.body.includes('ğŸ¤– AI ì½”ë“œ ë¦¬ë·°')
          );

          const commentBody = "## ğŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n" + review + "\n\n---\n<details>\n<summary>ğŸ’¡ ë¦¬ë·° ì •ë³´</summary>\n\n- ëª¨ë¸: Grok-4-fast\n- ë¦¬ë·° ì‹œê°„: " + new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'}) + "\n- PR: #${{ github.event.number }}\n\n</details>";

          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }