name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: AI Code Review
      uses: actions/github-script@v7
      with:
        script: |
          const OPENROUTER_API_KEY = '${{ secrets.OPENROUTER_API_KEY }}';

          const diff = await github.rest.repos.compareCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            base: context.payload.pull_request.base.sha,
            head: context.payload.pull_request.head.sha
          });

          const filesToReview = diff.data.files.filter(file =>
            file.patch &&
            !file.filename.includes('test/') &&
            !file.filename.includes('build/') &&
            (file.filename.endsWith('.kt') ||
             file.filename.endsWith('.kts') ||
             file.filename.endsWith('.java') ||
             file.filename.endsWith('.yml') ||
             file.filename.endsWith('.yaml') ||
             file.filename.endsWith('.md'))
          );

          if (filesToReview.length === 0) {
            console.log('No files to review');
            return;
          }

          console.log(`Found ${filesToReview.length} files to review`);

          let overallReview = `## ğŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n`;

          let allChanges = '';
          const filesSummary = [];

          for (const file of filesToReview) {
            filesSummary.push(`- ${file.filename} (+${file.additions}/-${file.deletions})`);
            allChanges += `\n### ${file.filename}\n`;
            allChanges += `\`\`\`diff\n${file.patch}\n\`\`\`\n`;
          }

          try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'x-ai/grok-4-fast:free',
                messages: [{
                  role: 'system',
                  content: `ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. ë‹¤ìŒ ê·œì¹™ë§Œ ê²€í† í•˜ì„¸ìš”:

## ê²€í†  í•­ëª©
1. **ê¸€ë¡œë²Œ ìµì…‰ì…˜ ì²˜ë¦¬**: @ControllerAdvice ì‚¬ìš©, í‘œì¤€ ì—ëŸ¬ ì‘ë‹µ
2. **ApiResponse ì‚¬ìš©**: ëª¨ë“  APIëŠ” ApiResponse<T>ë¡œ ê°ì‹¸ì„œ ì‘ë‹µ
3. **Kotlin ìµœì í™”**: data class, null safety, when í‘œí˜„ì‹, í™•ì¥í•¨ìˆ˜ ë“±
4. **ktlint ê·œì¹™**: í¬ë§·íŒ…, ë„¤ì´ë° ì»¨ë²¤ì…˜

## ì‘ë‹µ í˜•ì‹
### âœ… ì¤€ìˆ˜ì‚¬í•­
- [ì˜ ì§€ì¼œì§„ ë¶€ë¶„]

### âŒ ìœ„ë°˜ì‚¬í•­
- [íŒŒì¼:ë¼ì¸] ë¬¸ì œì ê³¼ ìˆ˜ì •ë°©ë²•

**ì ìˆ˜**: X/10`
                }, {
                  role: 'user',
                  content: `ë‹¤ìŒ PRì˜ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”:

PR ì œëª©: ${{ github.event.pull_request.title }}
PR ì„¤ëª…: ${{ github.event.pull_request.body }}

ë³€ê²½ëœ íŒŒì¼:
${filesSummary.join('\n')}

ì „ì²´ ë³€ê²½ì‚¬í•­:
${allChanges}`
                }],
                temperature: 0.3
              })
            });

            if (response.ok) {
              const result = await response.json();
              overallReview += result.choices[0].message.content + '\n\n';
              console.log('âœ… API review completed successfully!');
            } else {
              const errorText = await response.text();
              console.error('API request failed:', response.status, errorText);
              overallReview += `> âš ï¸ ë¦¬ë·° ì‹¤íŒ¨: ${response.status} - ${errorText}\n\n`;
            }
          } catch (error) {
            console.error('Error during review:', error);
            overallReview += `> âš ï¸ ë¦¬ë·° ì‹¤íŒ¨: ${error.message}\n\n`;
          }

          overallReview += `---\n`;
          overallReview += `<details>\n<summary>ğŸ’¡ ë¦¬ë·° ì •ë³´</summary>\n\n`;
          overallReview += `- ëª¨ë¸: Grok-4-fast\n`;
          overallReview += `- ë¦¬ë·° ì‹œê°„: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}\n`;
          overallReview += `- PR: #${{ github.event.number }}\n\n`;
          overallReview += `</details>`;

          await github.rest.pulls.createReview({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
            body: overallReview,
            event: 'COMMENT'
          });

          console.log(`âœ… Review completed for ${filesToReview.length} files!`);